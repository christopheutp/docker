ARG NODE_VERSION=18

FROM node:${NODE_VERSION}-alpine AS builder
WORKDIR /app
COPY package.json ./
RUN npm install
COPY app.js .
RUN npm test

FROM node:${NODE_VERSION}-alpine AS production
WORKDIR /app
COPY --from=builder /app/node_modules ./node_modules
COPY app.js .

RUN addgroup -g 1001 appgroup \
 && adduser -D -u 1001 -G appgroup appuser

USER appuser

ENV APP_ENV=production
ENV PORT=3000

EXPOSE 3000
CMD ["node", "app.js"]
